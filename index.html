<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>皮克敏戳戳樂 WebAudio 完整版</title>

<style>
body {
  margin: 0;
  background: #fff;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  font-family: sans-serif;
}

#startScreen {
  position: fixed;
  inset: 0;
  background: white;
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 10;
}

#startBtn {
  padding: 16px 36px;
  font-size: 18px;
  border-radius: 999px;
  border: none;
  background: #111;
  color: white;
}

.container {
  position: relative;
  display: none;
}

#pikmin {
  width: 140px;
  transform-origin: center bottom;
  user-select: none;
  touch-action: none;
}

#label {
  position: absolute;
  top: -28px;
  left: 50%;
  transform: translateX(-50%);
  font-weight: bold;
}

.animate-back {
  transition: transform 0.35s cubic-bezier(0.22, 1, 0.36, 1);
}

@keyframes dropBounce {
  0% { transform: translateY(-120px); }
  60% { transform: translateY(10px); }
  80% { transform: translateY(-5px); }
  100% { transform: translateY(0); }
}

.drop-bounce {
  animation: dropBounce 0.5s ease-out forwards;
}
</style>
</head>

<body>

<div id="startScreen">
  <button id="startBtn">開始</button>
</div>

<div class="container">
  <img id="pikmin" src="IMG_5128.jpeg">
  <div id="label">往上拉</div>
</div>

<script>
/* ================== Web Audio Engine ================== */
let audioCtx;
const buffers = {};
let dragSource = null;
let dragGain = null;

async function loadSound(name, src) {
  const res = await fetch(src);
  const data = await res.arrayBuffer();
  buffers[name] = await audioCtx.decodeAudioData(data);
}

function playOneShot(name, volume = 1) {
  const source = audioCtx.createBufferSource();
  const gain = audioCtx.createGain();
  gain.gain.value = volume;

  source.buffer = buffers[name];
  source.connect(gain).connect(audioCtx.destination);
  source.start(0);
}

function startDragLoop(name) {
  stopDragLoop();
  dragSource = audioCtx.createBufferSource();
  dragGain = audioCtx.createGain();
  dragGain.gain.value = 0.6;

  dragSource.buffer = buffers[name];
  dragSource.loop = true;
  dragSource.connect(dragGain).connect(audioCtx.destination);
  dragSource.start();
}

function stopDragLoop() {
  if (dragSource) {
    dragSource.stop();
    dragSource.disconnect();
    dragSource = null;
  }
}

/* ================== Pikmin Data ================== */
const pikmins = [
  { src:"C2.jpg", text:"靠！有夠可愛", sound:"c11", volume:1 },
  { src:"Y2.jpg", text:"早安", sound:"ahoh", volume:0.8 },
  { src:"R2.jpg", text:"你好", sound:"p11", volume:0.7 },
  { src:"S2.jpg", text:"", sound:"p22", volume:0.6 },
  { src:"B2.jpg", text:"嘻嘻", sound:"p33", volume:0.6 },
  { src:"W2.jpg", text:"", sound:"p44", volume:0.5 },
  { src:"P2.jpg", text:"", sound:"p55", volume:0.8 },
  { src:"Pu2.jpg", text:"喵", sound:"meow", volume:0.4 }
];

/* ================== DOM ================== */
const pikmin = document.getElementById("pikmin");
const label = document.getElementById("label");
const startBtn = document.getElementById("startBtn");
const startScreen = document.getElementById("startScreen");
const container = document.querySelector(".container");

/* ================== Start ================== */
startBtn.addEventListener("click", async () => {
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  await Promise.all([
    loadSound("drag", "p33.mp3"),
    ...pikmins.map(p => loadSound(p.sound, p.sound + ".mp3"))
  ]);

  startScreen.style.display = "none";
  container.style.display = "block";
});

/* ================== Interaction ================== */
let startY = 0;
let dragging = false;
let popped = false;

const MAX = 80;
const RATIO = 0.5;

function setTransform(y, s=1) {
  pikmin.style.transform = `translateY(${y}px) scale(${s})`;
}

pikmin.addEventListener("pointerdown", e => {
  if (popped) return;
  dragging = true;
  startY = e.clientY;
  pikmin.classList.remove("animate-back");
  startDragLoop("drag");
});

pikmin.addEventListener("pointermove", e => {
  if (!dragging) return;
  const dy = Math.max(0, startY - e.clientY);
  const move = Math.min(dy * RATIO, MAX);
  setTransform(-move, 1 + move / MAX * 0.2);
});

pikmin.addEventListener("pointerup", e => {
  dragging = false;
  stopDragLoop();
  pikmin.classList.add("animate-back");

  const dy = (startY - e.clientY) * RATIO;
  if (dy > MAX * 0.95) {
    popped = true;
    const p = pikmins[Math.floor(Math.random()*pikmins.length)];
    pikmin.src = p.src;
    label.textContent = p.text;
    playOneShot(p.sound, p.volume);
    setTransform(-120, 1);
    pikmin.classList.add("drop-bounce");
  } else {
    setTransform(0, 1);
  }
});

pikmin.addEventListener("click", () => {
  if (!popped) return;
  popped = false;
  pikmin.src = "IMG_5128.jpeg";
  label.textContent = "往上拉";
  pikmin.classList.remove("drop-bounce");
  setTransform(0,1);
});
</script>

</body>
</html>