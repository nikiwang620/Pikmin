<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>皮克敏戳戳樂完整版</title>

<style>
body {
  margin: 0;
  background: #fff;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  font-family: sans-serif;
}

.container {
  position: relative;
  display: inline-block;
}

#pikmin {
  width: 140px;
  transform-origin: center bottom;
  user-select: none;
  touch-action: none;
  cursor: pointer;
}

.animate-back {
  transition: transform 0.35s cubic-bezier(0.22, 1, 0.36, 1);
}

#label {
  position: absolute;
  top: -28px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 14px;
  font-weight: bold;
  pointer-events: none;
}

@keyframes dropBounce {
  0%   { transform: translateY(-120px); }
  60%  { transform: translateY(10px); }
  80%  { transform: translateY(-5px); }
  100% { transform: translateY(0); }
}

.drop-bounce {
  animation: dropBounce 0.5s ease-out forwards;
}
</style>
</head>

<body>

<div class="container">
  <img id="pikmin" src="" alt="皮克敏">
  <div id="label">往上拉</div>
</div>

<script>
const pikmin = document.getElementById("pikmin");
const label = document.getElementById("label");

const firstImage = "IMG_5128.jpeg";

/* ========= Pikmin 資料 ========= */
const pikmins = [
  { src: "C2.jpg", text: "靠！有夠可愛", audio: "c11.mp3" },
  { src: "Y2.jpg", text: "早安", audio: "ahoh.mp3" },
  { src: "R2.jpg", text: "你好", audio: "p11.mp3" },
  { src: "S2.jpg", text: "", audio: "p22.mp3" },
  { src: "B2.jpg", text: "嘻嘻", audio: "p33.mp3" },
  { src: "W2.jpg", text: "", audio: "p44.mp3" },
  { src: "P2.jpg", text: "", audio: "p55.mp3" },
  { src: "Pu2.jpg", text: "喵", audio: "meow.mp3" }
];

pikmin.src = firstImage;

/* ========= 音效 ========= */

// 拉扯音（只播一次，用來當「拉扯時間條」）
const dragAudio = new Audio("p33.mp3");
dragAudio.loop = false;
dragAudio.preload = "auto";

// 每隻皮克敏音效
const audioPool = pikmins.map(p => {
  const a = new Audio(p.audio);
  a.preload = "auto";
  return a;
});

/* ========= 狀態 ========= */
let startY = 0;
let dragging = false;
let popped = false;
let upcomingIndex = null;
let activePointerId = null;

const MAX_MOVE = 80;
const MAX_SCALE = 1.2;
const DRAG_RATIO = 0.5;

/* ========= 輪播池 ========= */
let availableIndexes = [];
function resetAvailableIndexes() {
  availableIndexes = [];
  for (let i = 1; i < pikmins.length; i++) {
    availableIndexes.push(i);
  }
}
resetAvailableIndexes();

function drawRandomIndex() {
  if (availableIndexes.length === 0) resetAvailableIndexes();
  const r = Math.floor(Math.random() * availableIndexes.length);
  return availableIndexes.splice(r, 1)[0];
}

/* ========= Transform ========= */
function setTransform(y, scale) {
  pikmin.style.transform = `translateY(${y}px) scaleY(${scale})`;
}

/* ========= 強制結束拉扯（核心） ========= */
function forceEndDrag() {
  if (!dragging || popped) return;

  dragging = false;

  // 強制釋放 pointer（就算手還壓著）
  try {
    pikmin.releasePointerCapture(activePointerId);
  } catch (e) {}

  dragAudio.pause();
  dragAudio.currentTime = 0;

  pikmin.classList.add("animate-back");

  popped = true;

  let index = Math.random() < 0.15 ? 0 : (upcomingIndex ?? drawRandomIndex());
  const selected = pikmins[index];

  pikmin.src = selected.src;
  label.textContent = selected.text;

  const audio = audioPool[index];
  audio.currentTime = 0;
  audio.play();

  pikmin.style.transform = "translateY(-120px)";
  pikmin.classList.add("drop-bounce");
}

/* ========= Pointer Down ========= */
pikmin.addEventListener("pointerdown", e => {
  if (popped) return;

  dragging = true;
  startY = e.clientY;
  upcomingIndex = null;
  activePointerId = e.pointerId;

  pikmin.classList.remove("animate-back");
  pikmin.setPointerCapture(e.pointerId);

  dragAudio.currentTime = 0;
  dragAudio.play();
});

/* ========= Pointer Move ========= */
pikmin.addEventListener("pointermove", e => {
  if (!dragging || popped) return;

  const rawDelta = startY - e.clientY;
  if (rawDelta <= 0) return;

  const move = Math.min(rawDelta * DRAG_RATIO, MAX_MOVE);
  const progress = move / MAX_MOVE;
  const eased = progress * progress;

  setTransform(-move, 1 + eased * (MAX_SCALE - 1));
  label.textContent = "撐住中";

  if (upcomingIndex === null && progress > 0.7) {
    upcomingIndex = drawRandomIndex();
  }
});

/* ========= Pointer Up（可有可無，保險用） ========= */
pikmin.addEventListener("pointerup", () => {
  if (!dragging || popped) return;
  dragging = false;
  dragAudio.pause();
  dragAudio.currentTime = 0;
  setTransform(0, 1);
  label.textContent = "再拉一點";
});

/* ========= 音效播完 → 強制結束（關鍵） ========= */
dragAudio.addEventListener("ended", () => {
  forceEndDrag();
});

/* ========= 點擊重置 ========= */
pikmin.addEventListener("click", () => {
  if (!popped) return;

  popped = false;
  label.textContent = "往上拉";
  pikmin.classList.remove("drop-bounce");
  pikmin.src = firstImage;
  setTransform(0, 1);
});
</script>

</body>
</html>