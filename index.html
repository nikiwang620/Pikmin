<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>記得要開聲音才好玩</title>

<style>
body {
  margin: 0;
  background: #fff;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  font-family: sans-serif;
  transition: background 0.4s ease;
}

/* ===== 遊戲背景 ===== */
body.game-bg {
  background-image: url("grass.jpg");
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
}

/* ===== 開始畫面 ===== */
#startScreen {
  position: fixed;
  inset: 0;
  background: white;
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 10;
}

#startBtn {
  padding: 16px 36px;
  font-size: 18px;
  border-radius: 999px;
  border: none;
  background: #111;
  color: white;
}

/* ===== 主畫面 ===== */
.container {
  position: relative;
  display: none;
}

#pikmin {
  width: 180px;
  transform-origin: center bottom;
  user-select: none;
  touch-action: none;
}

#label {
  position: absolute;
  top: -28px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 14px;
  font-weight: bold;
  pointer-events: none;
}

.animate-back {
  transition: transform 0.3s cubic-bezier(0.22, 1, 0.36, 1);
}

@keyframes dropBounce {
  0%   { transform: translateY(-120px) scaleY(1); }
  60%  { transform: translateY(10px) scaleY(0.95); }
  80%  { transform: translateY(-5px) scaleY(1.02); }
  100% { transform: translateY(0) scaleY(1); }
}

.drop-bounce {
  animation: dropBounce 0.5s ease-out forwards;
}
</style>
</head>

<body>

<div id="startScreen">
  <button id="startBtn">開始</button>
</div>

<div class="container">
  <img id="pikmin" src="IMG_5128.jpeg">
  <div id="label">往上拉</div>
</div>

<script>
/* ================= Audio ================= */
let audioCtx;
const buffers = {};
let dragSource = null;

async function loadSound(name, src) {
  const res = await fetch(src);
  const data = await res.arrayBuffer();
  buffers[name] = await audioCtx.decodeAudioData(data);
}

function playOneShot(name, volume = 1) {
  const src = audioCtx.createBufferSource();
  const gain = audioCtx.createGain();
  gain.gain.value = volume;
  src.buffer = buffers[name];
  src.connect(gain).connect(audioCtx.destination);
  src.start();
}

function startDragLoop(name) {
  stopDragLoop();
  dragSource = audioCtx.createBufferSource();
  const gain = audioCtx.createGain();
  gain.gain.value = 0.6;
  dragSource.buffer = buffers[name];
  dragSource.loop = true;
  dragSource.connect(gain).connect(audioCtx.destination);
  dragSource.start();
}

function stopDragLoop() {
  if (dragSource) {
    dragSource.stop();
    dragSource.disconnect();
    dragSource = null;
  }
}

/* ================= 資料 ================= */
const pikmins = [
  { src:"C2.jpg",  sound:"c11",  volume:0.5, size:200 },
  { src:"Y2.JPG",  sound:"ahoh", volume:0.5, size:250 },
  { src:"R2.JPG",  sound:"p11",  volume:0.5, size:250 },
  { src:"B2.jpg",  sound:"p44",  volume:0.5, size:250 },
  { src:"Pu2.jpg", sound:"meow", volume:1,   size:300 },
];

/* ===== 每輪出現限制 ===== */
let appearCount = new Map();

function resetRound() {
  appearCount.clear();
  pikmins.forEach(p => appearCount.set(p.src, 0));
}

function getRandomPikminLimited() {
  let available = pikmins.filter(p => appearCount.get(p.src) < 2);

  if (available.length === 0) {
    resetRound();
    available = [...pikmins];
  }

  const p = available[Math.floor(Math.random() * available.length)];
  appearCount.set(p.src, appearCount.get(p.src) + 1);
  return p;
}

/* ================= DOM ================= */
const pikmin = document.getElementById("pikmin");
const label = document.getElementById("label");
const startBtn = document.getElementById("startBtn");
const startScreen = document.getElementById("startScreen");
const container = document.querySelector(".container");

/* ================= 啟動 ================= */
startBtn.addEventListener("click", async () => {
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  document.body.classList.add("game-bg");

  await Promise.all([
    loadSound("drag", "p33.mp3"),
    ...pikmins.map(p => loadSound(p.sound, p.sound + ".mp3"))
  ]);

  resetRound();

  startScreen.style.display = "none";
  container.style.display = "block";
});

/* ================= 互動 ================= */
let startY = 0;
let dragging = false;
let popped = false;

const MAX_MOVE = 80;
const RATIO = 0.5;

function applyStretch(move) {
  const progress = move / MAX_MOVE;
  const stretch = 1 + progress * 0.2;
  const squash  = 1 - progress * 0.08;

  pikmin.style.transform = `
    translateY(${-move}px)
    scaleX(${squash})
    scaleY(${stretch})
  `;
}

pikmin.addEventListener("pointerdown", e => {
  if (popped) return;
  dragging = true;
  startY = e.clientY;
  pikmin.classList.remove("animate-back");
  startDragLoop("drag");
});

pikmin.addEventListener("pointermove", e => {
  if (!dragging) return;
  const dy = Math.max(0, startY - e.clientY);
  const move = Math.min(dy * RATIO, MAX_MOVE);
  label.textContent = "撐...";
  applyStretch(move);
});

pikmin.addEventListener("pointerup", e => {
  if (!dragging) return;
  dragging = false;
  stopDragLoop();

  const dy = (startY - e.clientY) * RATIO;

  if (dy > MAX_MOVE * 0.95) {
    popped = true;

    pikmin.style.transform = "translateY(0) scale(1)";
    pikmin.offsetHeight;

    const p = getRandomPikminLimited();
    pikmin.src = p.src;
    pikmin.style.width = p.size + "px";
    playOneShot(p.sound, p.volume);

    pikmin.classList.add("drop-bounce");
  } else {
    pikmin.classList.add("animate-back");
    pikmin.style.transform = "translateY(0) scale(1)";
    label.textContent = "再拉一次";
  }
});

pikmin.addEventListener("click", () => {
  if (!popped) return;
  popped = false;
  pikmin.src = "IMG_5128.jpeg";
  pikmin.style.width = "180px";
  label.textContent = "往上拉";
  pikmin.classList.remove("drop-bounce");
  pikmin.style.transform = "translateY(0) scale(1)";
});
</script>

</body>
</html>