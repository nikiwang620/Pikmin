<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>皮克敏戳戳樂完整版</title>

<style>
body {
  margin: 0;
  background: #fff;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  font-family: sans-serif;
}

.container {
  position: relative;
  display: inline-block;
}

#pikmin {
  width: 140px;
  transform-origin: center bottom;
  user-select: none;
  touch-action: none;
  will-change: transform;
  cursor: pointer;
}

.animate-back {
  transition: transform 0.35s cubic-bezier(0.22, 1, 0.36, 1);
}

#label {
  position: absolute;
  top: -28px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 14px;
  font-weight: bold;
  pointer-events: none;
}

@keyframes dropBounce {
  0%   { transform: translateY(-120px); }
  60%  { transform: translateY(10px); }
  80%  { transform: translateY(-5px); }
  100% { transform: translateY(0); }
}

.drop-bounce {
  animation: dropBounce 0.5s ease-out forwards;
}
</style>
</head>

<body>

<div class="container">
  <img id="pikmin" src="" alt="皮克敏">
  <div id="label">往上拉</div>
</div>

<script>
const pikmin = document.getElementById("pikmin");
const label = document.getElementById("label");

const firstImage = "IMG_5128.jpeg";

// ===== Pikmin 資料 =====
const pikmins = [
  { src: "C2.jpg", text: "冷靜冷靜", audio: "Cv.mp3" }, // C2
  { src: "Y2.jpg", text: "嗶！", audio: "ahoh.mp3" },
  { src: "R2.jpg", text: "嗚～", audio: "p1.mp3" },
  { src: "S2.jpg", text: "", audio: "p2.mp3" },
  { src: "B2.jpg", text: "", audio: "p3.mp3" },
  { src: "W2.jpg", text: "", audio: "p4.mp3" },
  { src: "P2.jpg", text: "", audio: "Cv.mp3" },
  { src: "Pu2.jpg", text: "", audio: "meow.mp3" }
];

// 初始圖片
pikmin.src = firstImage;

// ===== 音效池 =====
const audioPool = pikmins.map(p => {
  const a = new Audio(p.audio);
  a.preload = "auto";
  return a;
});

// ===== 狀態 =====
let startY = 0;
let dragging = false;
let popped = false;
let soundPlayed = false;
let upcomingIndex = null;

let currentAudio = null;
let canReturn = false;

const MAX_MOVE = 80;
const MAX_SCALE = 1.2;
const DRAG_RATIO = 0.5;
const SOUND_TRIGGER_RATIO = 0.9;

// ===== 輪播池（不重複）=====
let availableIndexes = [];
function resetAvailableIndexes() {
  availableIndexes = [];
  for (let i = 1; i < pikmins.length; i++) {
    availableIndexes.push(i);
  }
}
resetAvailableIndexes();

function drawRandomIndex() {
  if (availableIndexes.length === 0) resetAvailableIndexes();
  const rand = Math.floor(Math.random() * availableIndexes.length);
  return availableIndexes.splice(rand, 1)[0];
}

// ===== transform =====
function setTransform(y, scale) {
  pikmin.style.transform = `translateY(${y}px) scaleY(${scale})`;
}

// ===== pointerdown =====
pikmin.addEventListener("pointerdown", (e) => {
  if (popped) return;

  dragging = true;
  startY = e.clientY;
  soundPlayed = false;
  upcomingIndex = null;

  pikmin.classList.remove("animate-back");
  pikmin.setPointerCapture(e.pointerId);
});

// ===== pointermove =====
pikmin.addEventListener("pointermove", (e) => {
  if (!dragging || popped) return;

  const rawDelta = startY - e.clientY;
  if (rawDelta <= 0) return;

  const move = Math.min(rawDelta * DRAG_RATIO, MAX_MOVE);
  const progress = move / MAX_MOVE;
  const eased = progress * progress;

  setTransform(-move, 1 + eased * (MAX_SCALE - 1));

  if (progress >= SOUND_TRIGGER_RATIO && !soundPlayed) {
    label.textContent = "撐住中";

    upcomingIndex = drawRandomIndex();
    const audio = audioPool[upcomingIndex];
    audio.currentTime = 0;
    audio.play();

    soundPlayed = true;
  }
});

// ===== pointerup =====
pikmin.addEventListener("pointerup", (e) => {
  if (!dragging) return;
  dragging = false;

  pikmin.classList.add("animate-back");
  const dragAmount = (startY - e.clientY) * DRAG_RATIO;

  if (dragAmount >= MAX_MOVE * 0.95) {
    popped = true;

    let index;
    if (Math.random() < 0.15) {
      index = 0; // C2
    } else {
      index = upcomingIndex ?? drawRandomIndex();
    }

    const selected = pikmins[index];
    pikmin.src = selected.src;
    label.textContent = selected.text;

    const audio = audioPool[index];
    audio.currentTime = 0;
    audio.play();

    currentAudio = audio;
    canReturn = false;

    audio.onended = () => {
      canReturn = true;
      label.textContent = "點我回家";
    };

    pikmin.style.transform = "translateY(-120px)";
    pikmin.classList.add("drop-bounce");

    upcomingIndex = null;
    soundPlayed = false;
  } else {
    setTransform(0, 1);
    label.textContent = "再拉一點";
  }
});

// ===== 點擊回到盆栽（音樂播完才行）=====
pikmin.addEventListener("click", () => {
  if (!popped) return;
  if (!canReturn) return;

  popped = false;
  canReturn = false;

  pikmin.classList.remove("drop-bounce");
  pikmin.src = firstImage;
  label.textContent = "往上拉";
  setTransform(0, 1);
});
</script>

</body>
</html>